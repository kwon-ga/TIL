<br>

## ✔ 자바스크립트의 동작 원리

<br>

### ✅ RunTime

<br>

프로그래밍 언어가 구동되는 환경을 의미한다.

자바스크립트는 다양한 런타임 속에서 실행된다.

다른 언어와 비교해보면, Python은 공식 인터프리터가 주기적으로 업데이트 되며 모든 Python 개발자는 공식 인터프리터를 사용한다. 

Java 또한 공식 JDK가 배포 및 관리되고 있어서 Java 개발자들은 모두 JVM이라는 동일한 Java Runtime을 이용한다고 가정하고 개발한다.

반면에 자바스크립트는 같은 코드여도, 런타임에 따라 실행 양상이 다를 수 있다.

그럼에도 모든 자바스크립트 런타임들은 비슷한 구조와 동작 방식을 가지고 있다.

<br>

### ✔ Runtime 기본 4요소

<br>

1.JavaScript Engine : Call Stack, Heep Memory  
2.Background : 비동기 task를 수행하는 Multi Threads  
3.다양한 Tesk Queue : Backgroend 작업 수행 후 Callback을 관리  
4.Event Loop : Single Thread, Non-blocking IO의 책임

<br>

***

<br>

### ✅ JavaScript Engine

<br>

자바스크립트 엔진은 자바스크립트 코드를 해석하고 실행하는 인터프리터, 코드를 바탕으로 현재 실행중인 서브루틴을 관리하는 Call Stack, 그리고 변수와 객체에 대한 메모리 할당 및 관리를 담당하는 Heap Memory로 구성되어 있다.

자바스크립트 엔진은 js 파일을 읽으면서 Call stack을 채우고, Call stack에 있는 작업에 대한 수행을 반복한다.

*스레드 당 하나의 스택메모리를 사용하는데, 자바스크립트는 싱글스레드 언어이기 때문에 스택 메모리 하나를 사용한다.

<br>

### ✅ Memory Heep

<br>

메모리 힙은 메모리의 할당이 일어나는 곳이다.

참조타입(객체, 배열, 함수 등) 데이터가 저장된다.

참조타입 데이터가 저장된 메모리 주소 값은 콜스택의 변수 식별자의 값으로 각각 저장된다. (객체, 배열, 함수 등의 참조타입에 대한 주소값이 지정되면, 그 주소값이 콜스택의 변수 식별자 값으로 지정된다. 함수 실행 시 주소값을 통해 해당 참조타입을 찾을 수 있도록)

<br>

### ✅ Call Stack  

<br>

호출 스택은 메모리에 존재하는 공간 중의 하나로, 코드를 읽어내려 가면서 수행할 작업들을 밑에서부터 하나씩 쌓고, 메모리 힙에서 작업 수행에 필요한 것들을 찾아서 작업을 수행하는 공간이다.

자바스크립트는 단일 스레드 프로그래밍 언어이므로, 단일 호출 스택이 있다. 

단일 호출 스택이 있다는 뜻은 한 번에 하나의 일 (Task)만 처리할 수 있다는 뜻이다.

호출 스택 동작 방식의 예)

1.함수를 실행행한다.  
2.해당 함수의 기록을 스택 맨 위에 추가(push)한다.
3.함수의 결과 값을 반환하면 스택에 쌓여있던 함수는 제거(pop)된다.

<br>

```js
// 해당 코드로 콜스택의 과정을 알아보자
function multiply(x, y) {
    return x * y;
}
function printSquare(x) {
    var s = multiply(x, x);
    console.log(s);
}
printSquare(5);
```

<br>

|Stap1|Stap2|Stap3|Stap4|Stap5|
|:---:|:---:|:---:|:---:|:---:|
||multiply(x, x)|console.log(s)|||
|printSquare(5)|printSquare(5)|printSquare(5)|printSquare(5)||

<br>

### ✔ 예외처리, 스택 오버플로우

<br>

예외 처리가 되는 경우에는 스택의 호출이 어떤 순서로 일어나는지 알려준다.

스택 오버플로우는 이름 그대로 스택의 사이즈를 초과 했을때 발생하는 오류인데, 재귀 호출을 하는 경우에 주로 발생하는 오류이다.

<br>

### ✔ 단일 호출 스택의 문제점

<br>

단일 스레드에서 코드를 실행하는 것은 멀티 스레드 환경에서 발생하는 복잡한 시나리오를 고려할 필요가 없으므로 상대적으로 쉽다. 

하지만 단일 스레드에서 실행하는 것 자체가 상당히 제한적이다.

자바스크립트의 경우 하나의 호출 스택만 있기 때문에, 하나의 함수 처리가 매우 느려서 다른 함수 실행에 영향을 주는 경우를 방지하기 위해 비동기 콜백을 사용한다.


<br>

### ✅ Asynchronous callbacks

<br>

[비동기 콜백이란 ? ](./CallBack.md)

비동기 콜백을 사용하여 코드 일부를 실행하고 나중에 실행될 콜백 함수를 제공한다.

비동기 콜백은 동기 함수와는 다르게 특정 시점에 실행되므로 스택 안에서 바로 push 될 필요가 없다.

그렇다면 이러한 콜백 함수들은 어떻게 관리될까?

<br>

### ✅ Event Queue

<br>

### ✔  이벤트 큐와 비동기 콜백의 처리과정

<br>

자바스크립트 런타임은 기본적으로 이벤트 큐를 가지고 있다. 

이는 처리할 메세지 목록과 실행할 콜백 함수들의 리스트이다.

<비동기가 처리되는 과정>

1.클라이언트 화면에서 버튼 클릭과 같은 이벤트가 발생한다.

-> DOM 이벤트, http 요청, setTimeout 등과 같은 비동기 함수는 web API를 호출한다.

2.호출된 web API는 콜백 함수를 이벤트 큐 (콜백 큐)에 push한다. 

3.이벤트 큐는 대기하다가 스택이 텅 비는 시점에 이벤트 루프를 돌린다. (스택에 push)

-> 이벤트 루프의 기본 역할은 큐와 스택, 두 부분을 모니터링 하다가 스택이 비는 시점에 콜백을 시켜주는 역할을 한다.

<br>

### ✅ Event Loop

<br>

Event Loop란 ?

Event Loop는 자바스크립트 런타임의 중심에서 Call Stack과 Background 간의 업무 처리를 돕는 중개자 역할을 한다.

무한 루프를 돌면서 Callback (Task) 을 Background에서 Task Queue 로, Task Queue 에서 엔진의 Call Stack 으로 적절하게 전달한다.

Single Thread로 구성되어있고, background의 작업 수행을 기다리지 않기 때문에 Non-Blocking의 특징을 가지고 있다.

추가로 이벤트 루프는 첫 번째로 들어온 값이 첫 번째로 나가는 구조를 가지고 있다.

[자바스크립트 호출 스택 동작 예제 !](https://new93helloworld.tistory.com/361)


***
